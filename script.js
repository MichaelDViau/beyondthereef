const translations = {
  en: {
    global: {
      'nav.primary': 'Primary',
      'nav.toggle': 'Toggle navigation',
      'nav.home': 'Home',
      'nav.create': 'Create Your Experience',
      'nav.reviews': 'Reviews',
      'nav.story': 'Our Story',
      'nav.contact': 'Contact',
      'footer.rights': 'Beyond the Reef Adventures. All rights reserved.',
      'floatingContact.aria': 'Quick contact options',
      'floatingContact.whatsappAria': 'Chat on WhatsApp',
      'floatingContact.instagramAria': 'Open Instagram',
      'themeToggle.dark': 'Dark mode',
      'themeToggle.light': 'Light mode',
      'heroSlider.goToSlide': 'Go to slide {{index}}',
      'tourBuilder.remove': 'Remove'
    },
    home: {
      'page.title': 'Beyond the Reef Adventures',
      'home.hero.aria': 'Featured Experiences',
      'home.hero.heading': 'Pure adrenaline. Untamed nature. Your story in the making.',
      'home.hero.description':
        'Not just a day out — this is freedom unleashed. Swim with turtles, dive into cenotes, race across lagoons, and explore ancient Mayan ruins. No crowds. No limits. Just raw adventure carved into the heart of the Riviera Maya. Your rules. Your pace. Your unforgettable. This isn’t tourism. This is Beyond the Reef.',
      'home.hero.previous': 'Previous slide',
      'home.hero.next': 'Next slide',
      'home.hero.dots': 'Featured slides',
      'home.difference.heading': 'Experience the Difference',
      'home.difference.captured.title': 'Captured',
      'home.difference.captured.copy': 'Complimentary Photography on Every Tour',
      'home.difference.pace.title': 'Set the Pace',
      'home.difference.pace.copy': 'Choose your start time, skip pickups, set your own schedule',
      'home.difference.journey.title': 'Your Journey',
      'home.difference.journey.copy': 'Snorkel, explore, taste, relax — the choice is yours',
      'home.difference.surprises.title': 'No Surprises',
      'home.difference.surprises.copy': 'No hidden costs, No extra charges, Just adventure',
      'home.difference.excellence.title': 'Excellence',
      'home.difference.excellence.copy': 'We don’t claim it — our guests do. Five stars, every time.',
      'home.builder.eyebrow': 'Build your tour',
      'home.builder.heading': 'Design a custom itinerary in minutes',
      'home.builder.copy':
        'Create a bespoke adventure by mixing activities, dining, and relaxation. Add each idea to your itinerary and we will weave it into a seamless journey.',
      'home.builder.formAria': 'Add an activity to your custom tour',
      'home.builder.activityLabel': 'Activity name',
      'home.builder.activityPlaceholder': 'Night snorkel',
      'home.builder.dateLabel': 'Preferred date',
      'home.builder.notesLabel': 'Special touches',
      'home.builder.notesPlaceholder': 'Add a sunset picnic with locally sourced fruit.',
      'home.builder.add': 'Add to itinerary',
      'home.builder.listHeading': 'Your custom itinerary',
      'home.builder.placeholder':
        'Your ideas will appear here. Add the first one to begin crafting the perfect tour.',
      'home.builder.clear': 'Clear itinerary',
      'home.accent.eyebrow': 'Why travelers love us',
      'home.accent.heading': 'Concierge-level planning at lightning speed',
      'home.accent.locals.title': 'Crafted by locals',
      'home.accent.locals.copy':
        'Our specialists live on the islands year round, curating insider-only moments you cannot find on a brochure.',
      'home.accent.collab.title': 'Real-time collaboration',
      'home.accent.collab.copy':
        'Invite friends or family to add ideas to your itinerary and watch it come to life instantly.',
      'home.accent.execution.title': 'Seamless execution',
      'home.accent.execution.copy':
        'From airport transfer to last toast, your dedicated host orchestrates every detail while you unwind.',
      'home.cta.heading': 'Ready to feel the sea breeze?',
      'home.cta.copy': 'Answer a few questions and we will send a bespoke proposal within 24 hours.',
      'home.cta.button': 'Plan my escape'
    },
    tours: {
      'page.title': 'Build Your Tours | Beyond the Reef Adventures',
      'tours.hero.eyebrow': 'Build your tour',
      'tours.hero.heading': 'Design experiences as unique as your crew',
      'tours.hero.copy':
        'Drag and drop curated activities, refine pacing, and invite your travel companions to collaborate in real time.',
      'tours.grid.custom.title': 'Custom combinations',
      'tours.grid.custom.copy':
        'Mix scuba dives, culinary surprises, and remote hikes across islands. Our smart planner orchestrates logistics so you can focus on the fun.',
      'tours.grid.pacing.title': 'Smart pacing',
      'tours.grid.pacing.copy':
        'We balance high-energy adventures with restorative interludes, ensuring every guest has time to recharge.',
      'tours.grid.collab.title': 'Co-create instantly',
      'tours.grid.collab.copy':
        'Share a private link so your crew can vote, comment, or add new ideas. Our concierges can jump in live to fine-tune.',
      'tours.steps.heading': 'How the custom builder works',
      'tours.steps.one.title': 'Tell us about your dream',
      'tours.steps.one.copy': 'Answer a few questions or import a mood board. We use your vibe to pre-select experiences.',
      'tours.steps.two.title': 'Remix the plan',
      'tours.steps.two.copy':
        'Drag items between days, adjust timing, and add bespoke requests like photographers or private chefs.',
      'tours.steps.three.title': 'Lock it in',
      'tours.steps.three.copy':
        'Collaborate with your concierge to finalize transfers, payments, and on-island support.'
    },
    reviews: {
      'page.title': 'Guest Reviews | Beyond the Reef Adventures',
      'reviews.hero.eyebrow': 'Guest love letters',
      'reviews.hero.heading': 'Stories from travelers who went beyond',
      'reviews.hero.copy':
        'Hear how custom-crafted journeys and thoughtful touches turned bucket-list dreams into effortless escapes.',
      'reviews.featured.heading': 'Featured reviews',
      'reviews.featured.one.title': '“They thought of every detail.”',
      'reviews.featured.one.copy':
        '“From the midnight manta ray swim to the surprise anniversary dinner on a sandbar, the Beyond the Reef team went above and beyond. We never looked at our watches once.” — <strong>Cam &amp; Jordan</strong>',
      'reviews.featured.two.title': '“Planning was actually fun.”',
      'reviews.featured.two.copy':
        '“We built the itinerary together during a video call and could see availability update live. Their concierge secured a private guide for my dad so he could explore at his own pace.” — <strong>Riya</strong>',
      'reviews.featured.three.title': '“Our friends are still raving.”',
      'reviews.featured.three.copy':
        '“The group chat was blowing up with ideas. The Beyond the Reef planner kept everything organized and even added mixology classes based on our Spotify playlist.” — <strong>Diego &amp; crew</strong>',
      'reviews.share.heading': 'Share your experience',
      'reviews.share.copy':
        'Email <a href="mailto:hello@beyondthereef.com">hello@beyondthereef.com</a> with a highlight reel or tag us on social with <strong>#BeyondTheReef</strong> for a chance to be featured.'
    },
    story: {
      'page.title': 'Our Story | Beyond the Reef Adventures',
      'story.hero.eyebrow': 'Our story',
      'story.hero.heading': 'Born from a love of the sea and storytelling',
      'story.hero.copy':
        'We believe every traveler deserves a tailor-made narrative—crafted by locals, powered by technology, and infused with genuine hospitality.',
      'story.crew.heading': 'Meet the crew',
      'story.crew.lila.title': 'Lila Reyes — Founder',
      'story.crew.lila.copy':
        'A marine biologist turned travel designer, Lila launched Beyond the Reef to share hidden reefs and island communities with respectful explorers.',
      'story.crew.makai.title': 'Makai Thompson — Experience Architect',
      'story.crew.makai.copy':
        'Raised between three islands, Makai weaves cultural rituals, local artisans, and signature flavors into each itinerary.',
      'story.crew.sami.title': 'Sami Chen — Technology Lead',
      'story.crew.sami.copy':
        'Sami built our collaborative planning platform with real-time availability checks and concierge messaging that feels like texting a friend.',
      'story.values.heading': 'What we stand for',
      'story.values.regen.title': 'Regenerative travel',
      'story.values.regen.copy':
        'We partner with community-led conservation projects and donate a portion of every itinerary to reef restoration.',
      'story.values.hospitality.title': 'Hospitality with heart',
      'story.values.hospitality.copy':
        'Your hosts welcome you like family, preparing meaningful surprises and thoughtful touches along the way.',
      'story.values.tech.title': 'Technology that disappears',
      'story.values.tech.copy':
        'The planning tools are powerful, yet effortless, so you stay focused on excitement rather than logistics.'
    },
    contact: {
      'page.title': 'Contact | Beyond the Reef Adventures',
      'contact.hero.eyebrow': 'Say aloha',
      'contact.hero.heading': 'Let’s bring your next adventure to life',
      'contact.hero.copy':
        'Share a few details and our concierge team will respond within one business day with ideas and availability.',
      'contact.card.heading': 'Start a conversation',
      'contact.card.email': 'Email <a href="mailto:hello@beyondthereef.com">hello@beyondthereef.com</a>',
      'contact.card.phone': 'Call or WhatsApp <a href="tel:+529841670697">+52 984 167 0697</a>',
      'contact.card.hours': 'Office hours: Monday–Saturday, 8am–8pm local time',
      'contact.form.aria': 'Contact Beyond the Reef',
      'contact.form.nameLabel': 'Full name',
      'contact.form.namePlaceholder': 'Alex Morgan',
      'contact.form.emailLabel': 'Email',
      'contact.form.emailPlaceholder': 'you@example.com',
      'contact.form.phoneLabel': 'Phone',
      'contact.form.phonePlaceholder': 'Optional',
      'contact.form.datesLabel': 'Ideal travel window',
      'contact.form.datesPlaceholder': 'June 10 – 18, flexible',
      'contact.form.messageLabel': 'Tell us about your dream tour',
      'contact.form.messagePlaceholder': 'We want to celebrate with a sunset vow renewal...',
      'contact.form.submit': 'Send message',
      'contact.form.disclaimer': 'We respect your privacy and will never spam.'
    }
  },
  es: {
    global: {
      'nav.primary': 'Principal',
      'nav.toggle': 'Mostrar u ocultar la navegación',
      'nav.home': 'Inicio',
      'nav.create': 'Crea tu experiencia',
      'nav.reviews': 'Reseñas',
      'nav.story': 'Nuestra historia',
      'nav.contact': 'Contacto',
      'footer.rights': 'Beyond the Reef Adventures. Todos los derechos reservados.',
      'floatingContact.aria': 'Opciones de contacto rápido',
      'floatingContact.whatsappAria': 'Chatear en WhatsApp',
      'floatingContact.instagramAria': 'Abrir Instagram',
      'themeToggle.dark': 'Modo oscuro',
      'themeToggle.light': 'Modo claro',
      'heroSlider.goToSlide': 'Ir a la diapositiva {{index}}',
      'tourBuilder.remove': 'Eliminar'
    },
    home: {
      'page.title': 'Beyond the Reef Adventures',
      'home.hero.aria': 'Experiencias destacadas',
      'home.hero.heading': 'Pura adrenalina. Naturaleza indómita. Tu historia en marcha.',
      'home.hero.description':
        'No es solo una excursión: es libertad desatada. Nada con tortugas, sumérgete en cenotes, cruza lagunas a toda velocidad y explora antiguas ruinas mayas. Sin multitudes. Sin límites. Solo aventura pura en el corazón de la Riviera Maya. Tus reglas. Tu ritmo. Tu recuerdo inolvidable. Esto no es turismo. Esto es Beyond the Reef.',
      'home.hero.previous': 'Diapositiva anterior',
      'home.hero.next': 'Siguiente diapositiva',
      'home.hero.dots': 'Diapositivas destacadas',
      'home.difference.heading': 'Vive la diferencia',
      'home.difference.captured.title': 'Capturado',
      'home.difference.captured.copy': 'Fotografía incluida en cada tour',
      'home.difference.pace.title': 'Marca el ritmo',
      'home.difference.pace.copy': 'Elige tu horario, evita traslados y diseña tu propio itinerario',
      'home.difference.journey.title': 'Tu travesía',
      'home.difference.journey.copy': 'Snorkel, explorar, saborear o relajarte: tú decides',
      'home.difference.surprises.title': 'Sin sorpresas',
      'home.difference.surprises.copy': 'Sin costos ocultos, sin cargos extra, solo aventura',
      'home.difference.excellence.title': 'Excelencia',
      'home.difference.excellence.copy': 'No lo decimos nosotros: lo dicen nuestros huéspedes. Cinco estrellas siempre.',
      'home.builder.eyebrow': 'Diseña tu tour',
      'home.builder.heading': 'Crea un itinerario a medida en minutos',
      'home.builder.copy':
        'Diseña una aventura única combinando actividades, gastronomía y momentos de relajación. Agrega cada idea a tu itinerario y nosotros la convertiremos en un viaje perfecto.',
      'home.builder.formAria': 'Agrega una actividad a tu tour personalizado',
      'home.builder.activityLabel': 'Nombre de la actividad',
      'home.builder.activityPlaceholder': 'Snorkel nocturno',
      'home.builder.dateLabel': 'Fecha preferida',
      'home.builder.notesLabel': 'Toques especiales',
      'home.builder.notesPlaceholder': 'Incluye un picnic al atardecer con fruta local.',
      'home.builder.add': 'Agregar al itinerario',
      'home.builder.listHeading': 'Tu itinerario personalizado',
      'home.builder.placeholder':
        'Aquí aparecerán tus ideas. Agrega la primera para comenzar a crear el tour perfecto.',
      'home.builder.clear': 'Borrar itinerario',
      'home.accent.eyebrow': 'Por qué nos aman los viajeros',
      'home.accent.heading': 'Planificación de concierge a toda velocidad',
      'home.accent.locals.title': 'Creado por locales',
      'home.accent.locals.copy':
        'Nuestros especialistas viven en las islas todo el año y organizan momentos únicos que no encontrarás en un folleto.',
      'home.accent.collab.title': 'Colaboración en tiempo real',
      'home.accent.collab.copy':
        'Invita a tus amigos o familia a sumar ideas y mira cómo el plan cobra vida al instante.',
      'home.accent.execution.title': 'Ejecución impecable',
      'home.accent.execution.copy':
        'Desde el traslado hasta el último brindis, tu anfitrión se encarga de cada detalle mientras tú disfrutas.',
      'home.cta.heading': '¿Listo para sentir la brisa marina?',
      'home.cta.copy': 'Responde algunas preguntas y te enviaremos una propuesta personalizada en 24 horas.',
      'home.cta.button': 'Planear mi escape'
    },
    tours: {
      'page.title': 'Diseña tus tours | Beyond the Reef Adventures',
      'tours.hero.eyebrow': 'Diseña tu tour',
      'tours.hero.heading': 'Crea experiencias tan únicas como tu grupo',
      'tours.hero.copy':
        'Arrastra actividades seleccionadas, ajusta el ritmo e invita a tus acompañantes a colaborar en tiempo real.',
      'tours.grid.custom.title': 'Combinaciones a medida',
      'tours.grid.custom.copy':
        'Mezcla buceo, sorpresas culinarias y caminatas remotas. Nuestro planificador inteligente coordina la logística para que solo te concentres en disfrutar.',
      'tours.grid.pacing.title': 'Ritmo inteligente',
      'tours.grid.pacing.copy':
        'Equilibramos aventuras llenas de energía con momentos de descanso para que todos recarguen energías.',
      'tours.grid.collab.title': 'Co-creación al instante',
      'tours.grid.collab.copy':
        'Comparte un enlace privado para que tu equipo vote, comente o agregue nuevas ideas. Nuestros concierges pueden sumarse en vivo para ajustarlo.',
      'tours.steps.heading': 'Cómo funciona el constructor personalizado',
      'tours.steps.one.title': 'Cuéntanos tu sueño',
      'tours.steps.one.copy': 'Responde algunas preguntas o comparte un mood board. Usamos tu estilo para preseleccionar experiencias.',
      'tours.steps.two.title': 'Reinventa el plan',
      'tours.steps.two.copy':
        'Reordena actividades por día, ajusta horarios y agrega peticiones especiales como fotógrafos o chefs privados.',
      'tours.steps.three.title': 'Confírmalo todo',
      'tours.steps.three.copy':
        'Colabora con tu concierge para definir traslados, pagos y asistencia en destino.'
    },
    reviews: {
      'page.title': 'Reseñas de huéspedes | Beyond the Reef Adventures',
      'reviews.hero.eyebrow': 'Cartas de amor de nuestros huéspedes',
      'reviews.hero.heading': 'Historias de viajeros que fueron más allá',
      'reviews.hero.copy':
        'Descubre cómo los viajes personalizados y los detalles cuidadosos convirtieron sueños en escapadas sin esfuerzo.',
      'reviews.featured.heading': 'Reseñas destacadas',
      'reviews.featured.one.title': '“Pensaron en cada detalle.”',
      'reviews.featured.one.copy':
        '“Desde el nado nocturno con mantarrayas hasta la cena sorpresa de aniversario en un banco de arena, el equipo de Beyond the Reef superó todas las expectativas. No miramos el reloj ni una sola vez.” — <strong>Cam &amp; Jordan</strong>',
      'reviews.featured.two.title': '“Planear fue realmente divertido.”',
      'reviews.featured.two.copy':
        '“Construimos el itinerario juntos durante una videollamada y veíamos la disponibilidad en vivo. Su concierge consiguió un guía privado para mi papá para que explorara a su propio ritmo.” — <strong>Riya</strong>',
      'reviews.featured.three.title': '“Nuestros amigos siguen hablando del viaje.”',
      'reviews.featured.three.copy':
        '“El chat del grupo no dejaba de llenarse de ideas. El planificador de Beyond the Reef mantuvo todo organizado e incluso añadió clases de mixología inspiradas en nuestra lista de Spotify.” — <strong>Diego &amp; crew</strong>',
      'reviews.share.heading': 'Comparte tu experiencia',
      'reviews.share.copy':
        'Escríbenos a <a href="mailto:hello@beyondthereef.com">hello@beyondthereef.com</a> con los mejores momentos o etiquétanos en redes con <strong>#BeyondTheReef</strong> para tener la oportunidad de aparecer.'
    },
    story: {
      'page.title': 'Nuestra historia | Beyond the Reef Adventures',
      'story.hero.eyebrow': 'Nuestra historia',
      'story.hero.heading': 'Nacimos del amor por el mar y por contar historias',
      'story.hero.copy':
        'Creemos que cada viajero merece una narrativa a la medida: creada por locales, impulsada por la tecnología e impregnada de hospitalidad genuina.',
      'story.crew.heading': 'Conoce a la tripulación',
      'story.crew.lila.title': 'Lila Reyes — Fundadora',
      'story.crew.lila.copy':
        'Bióloga marina convertida en diseñadora de viajes, Lila creó Beyond the Reef para compartir arrecifes ocultos y comunidades isleñas con exploradores respetuosos.',
      'story.crew.makai.title': 'Makai Thompson — Arquitecto de Experiencias',
      'story.crew.makai.copy':
        'Criado entre tres islas, Makai teje rituales culturales, artesanos locales y sabores distintivos en cada itinerario.',
      'story.crew.sami.title': 'Sami Chen — Líder de Tecnología',
      'story.crew.sami.copy':
        'Sami desarrolló nuestra plataforma colaborativa con disponibilidad en tiempo real y mensajes de concierge que se sienten como chatear con un amigo.',
      'story.values.heading': 'Nuestros valores',
      'story.values.regen.title': 'Viajes regenerativos',
      'story.values.regen.copy':
        'Nos aliamos con proyectos comunitarios de conservación y destinamos parte de cada itinerario a la restauración de arrecifes.',
      'story.values.hospitality.title': 'Hospitalidad con corazón',
      'story.values.hospitality.copy':
        'Tus anfitriones te reciben como familia, preparando sorpresas significativas y detalles atentos durante todo el camino.',
      'story.values.tech.title': 'Tecnología que se difumina',
      'story.values.tech.copy':
        'Nuestras herramientas de planificación son potentes pero sencillas, para que te enfoques en la emoción y no en la logística.'
    },
    contact: {
      'page.title': 'Contacto | Beyond the Reef Adventures',
      'contact.hero.eyebrow': 'Di aloha',
      'contact.hero.heading': 'Hagamos realidad tu próxima aventura',
      'contact.hero.copy':
        'Comparte algunos detalles y nuestro equipo de concierge responderá en un día hábil con ideas y disponibilidad.',
      'contact.card.heading': 'Inicia la conversación',
      'contact.card.email': 'Escríbenos a <a href="mailto:hello@beyondthereef.com">hello@beyondthereef.com</a>',
      'contact.card.phone': 'Llámanos o mándanos WhatsApp al <a href="tel:+529841670697">+52 984 167 0697</a>',
      'contact.card.hours': 'Horario de oficina: lunes a sábado, 8 a.m. – 8 p.m. hora local',
      'contact.form.aria': 'Contacta a Beyond the Reef',
      'contact.form.nameLabel': 'Nombre completo',
      'contact.form.namePlaceholder': 'Alex Morgan',
      'contact.form.emailLabel': 'Correo electrónico',
      'contact.form.emailPlaceholder': 'tu@ejemplo.com',
      'contact.form.phoneLabel': 'Teléfono',
      'contact.form.phonePlaceholder': 'Opcional',
      'contact.form.datesLabel': 'Fechas ideales de viaje',
      'contact.form.datesPlaceholder': '10 al 18 de junio, flexible',
      'contact.form.messageLabel': 'Cuéntanos sobre tu tour soñado',
      'contact.form.messagePlaceholder': 'Queremos celebrar con una renovación de votos al atardecer...',
      'contact.form.submit': 'Enviar mensaje',
      'contact.form.disclaimer': 'Respetamos tu privacidad y nunca enviaremos spam.'
    }
  }
};

const SUPPORTED_LANGUAGES = ['en', 'es'];

function interpolate(template, replacements = {}) {
  return template.replace(/\{\{(\w+)\}\}/g, (_, key) =>
    Object.prototype.hasOwnProperty.call(replacements, key) ? String(replacements[key]) : ''
  );
}

function createLanguageManager(pageKey) {
  const LANGUAGE_STORAGE_KEY = 'preferred-language';
  const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY);
  const documentLanguage = document.documentElement.lang;
  let currentLanguage = SUPPORTED_LANGUAGES.includes(storedLanguage || '')
    ? storedLanguage
    : SUPPORTED_LANGUAGES.includes(documentLanguage)
    ? documentLanguage
    : 'en';
  const listeners = new Set();

  function getTranslationValue(lang, key) {
    const languageSet = translations[lang];
    if (!languageSet) return null;

    if (languageSet.global && Object.prototype.hasOwnProperty.call(languageSet.global, key)) {
      return languageSet.global[key];
    }

    if (pageKey && languageSet[pageKey] && Object.prototype.hasOwnProperty.call(languageSet[pageKey], key)) {
      return languageSet[pageKey][key];
    }

    return null;
  }

  function translateDocument(lang) {
    const languageSet = translations[lang];
    if (!languageSet) return;

    document.documentElement.lang = lang;

    const groups = [];
    if (languageSet.global) {
      groups.push(languageSet.global);
    }
    if (pageKey && languageSet[pageKey]) {
      groups.push(languageSet[pageKey]);
    }

    groups.forEach((group) => {
      Object.entries(group).forEach(([key, value]) => {
        const elements = document.querySelectorAll(`[data-i18n="${key}"]`);
        if (!elements.length) return;

        elements.forEach((element) => {
          const attr = element.dataset.i18nAttr;
          if (attr === 'html') {
            element.innerHTML = value;
          } else if (attr) {
            element.setAttribute(attr, value);
          } else {
            element.textContent = value;
          }
        });
      });
    });
  }

  function notify(lang) {
    listeners.forEach((callback) => {
      try {
        callback(lang);
      } catch (error) {
        console.error(error);
      }
    });
  }

  function applyLanguage(lang) {
    translateDocument(lang);
    notify(lang);
  }

  return {
    init() {
      applyLanguage(currentLanguage);
    },
    getLanguage() {
      return currentLanguage;
    },
    setLanguage(lang) {
      if (!SUPPORTED_LANGUAGES.includes(lang) || lang === currentLanguage) {
        return;
      }

      currentLanguage = lang;
      localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);
      applyLanguage(lang);
    },
    onChange(callback) {
      if (typeof callback !== 'function') {
        return () => {};
      }

      listeners.add(callback);
      callback(currentLanguage);
      return () => listeners.delete(callback);
    },
    translate(key, replacements = {}, lang = currentLanguage) {
      const template = getTranslationValue(lang, key);
      if (typeof template !== 'string') {
        return '';
      }

      return interpolate(template, replacements);
    }
  };
}

(function () {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

  document.addEventListener('DOMContentLoaded', () => {
    const pageKey = document.body?.dataset.page || 'home';
    const languageManager = createLanguageManager(pageKey);

    setupNavigation();
    setupLanguageToggle(languageManager);
    setupThemeToggle(prefersDark, languageManager);
    setupHeroSlider(languageManager);
    setupTourBuilder(languageManager);
    setCurrentYear();

    languageManager.init();
  });
})();

function setupNavigation() {
  const navToggle = document.querySelector('[data-nav-toggle]');
  const navLinks = document.querySelector('.nav__links');

  if (!navToggle || !navLinks) return;

  navToggle.addEventListener('click', () => {
    const isOpen = navLinks.classList.toggle('open');
    navToggle.setAttribute('aria-expanded', String(isOpen));
  });

  navLinks.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      if (navLinks.classList.contains('open')) {
        navLinks.classList.remove('open');
        navToggle.setAttribute('aria-expanded', 'false');
      }
    });
  });
}

function setupLanguageToggle(languageManager) {
  const toggle = document.querySelector('[data-language-toggle]');
  if (!toggle) return;

  const updateToggle = (lang) => {
    const isSpanish = lang === 'es';
    const nextLanguage = isSpanish ? 'en' : 'es';
    toggle.textContent = nextLanguage === 'es' ? 'Español 🇲🇽' : 'English 🇺🇸';
    toggle.setAttribute('aria-pressed', isSpanish ? 'true' : 'false');
  };

  toggle.addEventListener('click', () => {
    const nextLanguage = languageManager.getLanguage() === 'en' ? 'es' : 'en';
    languageManager.setLanguage(nextLanguage);
  });

  languageManager.onChange(updateToggle);
}

function setupThemeToggle(prefersDark, languageManager) {
  const toggle = document.querySelector('[data-theme-toggle]');
  if (!toggle) return;

  const storedTheme = localStorage.getItem('preferred-theme');
  const shouldUseDark = storedTheme ? storedTheme === 'dark' : prefersDark?.matches;

  if (shouldUseDark) {
    document.body.classList.add('dark-mode');
  }
  toggle.setAttribute('aria-pressed', shouldUseDark ? 'true' : 'false');

  const updateLabel = (lang) => {
    const isDark = document.body.classList.contains('dark-mode');
    const key = isDark ? 'themeToggle.light' : 'themeToggle.dark';
    toggle.textContent = languageManager.translate(key, {}, lang);
  };

  toggle.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
    localStorage.setItem('preferred-theme', isDark ? 'dark' : 'light');
    updateLabel(languageManager.getLanguage());
  });

  prefersDark?.addEventListener?.('change', (event) => {
    if (!localStorage.getItem('preferred-theme')) {
      document.body.classList.toggle('dark-mode', event.matches);
      toggle.setAttribute('aria-pressed', event.matches ? 'true' : 'false');
      updateLabel(languageManager.getLanguage());
    }
  });

  languageManager.onChange(updateLabel);
}

function setupHeroSlider(languageManager) {
  const slider = document.querySelector('.hero-slider');
  if (!slider) return;

  const slides = Array.from(slider.querySelectorAll('.hero-slide'));
  const dotsContainer = slider.querySelector('.hero-slider__dots');
  const prevButton = slider.querySelector('[data-slide="prev"]');
  const nextButton = slider.querySelector('[data-slide="next"]');

  if (!slides.length) return;

  let currentIndex = slides.findIndex((slide) => slide.classList.contains('is-active'));
  if (currentIndex === -1) {
    slides[0].classList.add('is-active');
    currentIndex = 0;
  }

  const HAVE_CURRENT_DATA =
    typeof HTMLMediaElement !== 'undefined' ? HTMLMediaElement.HAVE_CURRENT_DATA : 2;
  let autoRotateTimer = null;
  const AUTO_ROTATE_INTERVAL = 7000;
  const hasMultipleSlides = slides.length > 1;

  slides.forEach((slide, index) => {
    const media = slide.querySelector('.hero-slide__media');
    if (!media) return;

    media.preload = index === currentIndex ? 'auto' : 'metadata';

    const markLoaded = () => {
      media.classList.add('is-loaded');
    };

    if (media.readyState >= HAVE_CURRENT_DATA) {
      markLoaded();
    } else {
      ['loadeddata', 'canplay'].forEach((eventName) => {
        media.addEventListener(eventName, markLoaded, { once: true });
      });
    }

    media.addEventListener(
      'error',
      () => {
        slide.classList.add('hero-slide--unavailable');
      },
      { once: true }
    );
  });

  function setSlideState(slide, isActive) {
    slide.classList.toggle('is-active', isActive);
    slide.setAttribute('aria-hidden', isActive ? 'false' : 'true');

    const video = slide.querySelector('video');
    if (!video) return;

    if (isActive) {
      if (video.preload !== 'auto') {
        video.preload = 'auto';
      }
      if (video.readyState < HAVE_CURRENT_DATA && typeof video.load === 'function') {
        video.load();
      }
      if (typeof video.play === 'function') {
        const playPromise = video.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch(() => {});
        }
      }
    } else {
      if (video.preload !== 'metadata') {
        video.preload = 'metadata';
      }
      if (typeof video.pause === 'function') {
        video.pause();
      }
      if (!video.loop) {
        try {
          video.currentTime = 0;
        } catch (error) {
          // Some browsers might not allow resetting the currentTime for certain sources.
        }
      }
    }
  }

  function syncSlides() {
    slides.forEach((slide, index) => {
      setSlideState(slide, index === currentIndex);
    });
  }

  function goToSlide(index) {
    const nextIndex = (index + slides.length) % slides.length;
    if (nextIndex === currentIndex) return;

    const previousSlide = slides[currentIndex];
    const nextSlide = slides[nextIndex];

    setSlideState(previousSlide, false);
    currentIndex = nextIndex;
    setSlideState(nextSlide, true);
    updateDots();
    restartAutoRotate();
  }

  function nextSlide() {
    goToSlide(currentIndex + 1);
  }

  function previousSlide() {
    goToSlide(currentIndex - 1);
  }

  function startAutoRotate() {
    if (!hasMultipleSlides) return;
    stopAutoRotate();
    autoRotateTimer = window.setInterval(nextSlide, AUTO_ROTATE_INTERVAL);
  }

  function stopAutoRotate() {
    if (autoRotateTimer) {
      window.clearInterval(autoRotateTimer);
      autoRotateTimer = null;
    }
  }

  function restartAutoRotate() {
    if (!hasMultipleSlides) return;
    stopAutoRotate();
    autoRotateTimer = window.setInterval(nextSlide, AUTO_ROTATE_INTERVAL);
  }

  function updateDotLabels(lang = languageManager.getLanguage()) {
    if (!dotsContainer) return;
    const dots = dotsContainer.querySelectorAll('.hero-slider__dot');
    dots.forEach((dot, index) => {
      dot.setAttribute('aria-label', languageManager.translate('heroSlider.goToSlide', { index: index + 1 }, lang));
    });
  }

  function buildDots() {
    if (!dotsContainer || !hasMultipleSlides) return;

    dotsContainer.innerHTML = '';
    slides.forEach((_, index) => {
      const dot = document.createElement('button');
      dot.className = 'hero-slider__dot';
      dot.type = 'button';
      dot.setAttribute('role', 'tab');
      dot.setAttribute('aria-label', languageManager.translate('heroSlider.goToSlide', { index: index + 1 }));
      dot.addEventListener('click', () => goToSlide(index));
      dotsContainer.append(dot);
    });

    updateDots();
  }

  function updateDots() {
    if (!dotsContainer || !hasMultipleSlides) return;
    const dots = dotsContainer.querySelectorAll('.hero-slider__dot');
    dots.forEach((dot, index) => {
      dot.setAttribute('aria-selected', index === currentIndex ? 'true' : 'false');
    });
    updateDotLabels();
  }

  syncSlides();

  prevButton?.addEventListener('click', previousSlide);
  nextButton?.addEventListener('click', nextSlide);

  if (hasMultipleSlides) {
    slider.addEventListener('mouseenter', stopAutoRotate);
    slider.addEventListener('mouseleave', startAutoRotate);
    slider.addEventListener('focusin', stopAutoRotate);
    slider.addEventListener('focusout', startAutoRotate);
  }

  buildDots();
  startAutoRotate();

  languageManager.onChange(updateDotLabels);
}

function setupTourBuilder(languageManager) {
  const form = document.querySelector('#tour-builder-form');
  const itineraryList = document.querySelector('#itinerary-list');
  const clearButton = document.querySelector('#clear-itinerary');

  if (!form || !itineraryList) return;

  const getItemCount = () => itineraryList.querySelectorAll('.itinerary-item').length;

  const updatePlaceholder = (lang = languageManager.getLanguage()) => {
    const placeholder = itineraryList.querySelector('.itinerary-list__placeholder');
    const message = languageManager.translate('home.builder.placeholder', {}, lang);

    if (getItemCount() === 0) {
      if (placeholder) {
        placeholder.textContent = message;
      } else {
        const newPlaceholder = document.createElement('li');
        newPlaceholder.className = 'itinerary-list__placeholder';
        newPlaceholder.dataset.i18n = 'home.builder.placeholder';
        newPlaceholder.textContent = message;
        itineraryList.append(newPlaceholder);
      }
    } else if (placeholder) {
      placeholder.remove();
    }
  };

  const updateRemoveButtons = (lang = languageManager.getLanguage()) => {
    itineraryList.querySelectorAll('.itinerary-item__remove').forEach((button) => {
      button.textContent = languageManager.translate('tourBuilder.remove', {}, lang);
    });
  };

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const activity = formData.get('activity');
    const date = formData.get('date');
    const notes = formData.get('notes');

    if (!activity) return;

    const item = document.createElement('li');
    item.className = 'itinerary-item';

    const heading = document.createElement('strong');
    heading.textContent = activity;
    item.append(heading);

    if (date) {
      const meta = document.createElement('div');
      meta.className = 'itinerary-item__meta';
      try {
        const formattedDate = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium' }).format(new Date(date));
        meta.innerHTML = `<span>📅 ${formattedDate}</span>`;
      } catch (error) {
        meta.textContent = `📅 ${date}`;
      }
      item.append(meta);
    }

    if (notes) {
      const note = document.createElement('p');
      note.textContent = notes;
      item.append(note);
    }

    const remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'itinerary-item__remove';
    remove.textContent = languageManager.translate('tourBuilder.remove');
    remove.addEventListener('click', () => {
      item.remove();
      updatePlaceholder();
      updateRemoveButtons();
    });

    item.append(remove);
    itineraryList.append(item);
    form.reset();
    updatePlaceholder();
    updateRemoveButtons();
  });

  clearButton?.addEventListener('click', () => {
    itineraryList.innerHTML = '';
    updatePlaceholder();
  });

  languageManager.onChange((lang) => {
    updatePlaceholder(lang);
    updateRemoveButtons(lang);
  });
}

function setCurrentYear() {
  const year = document.querySelector('#current-year');
  if (year) {
    year.textContent = new Date().getFullYear();
  }
}
